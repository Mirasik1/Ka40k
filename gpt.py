import base64
from io import BytesIO
from PIL import Image
from API_KEYS import OPENAI_API_KEY
import requests
import datetime
import os
import db

LOG_FILE = "gpt_usage.log"

def analyze_food(photo_bytes,user_description):
    # --- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    image = Image.open(BytesIO(photo_bytes))
    image = image.convert("RGB")
    image = image.resize((512, 512))
    buffer = BytesIO()
    image.save(buffer, format="JPEG", quality=85)
    compressed_bytes = buffer.getvalue()

    photo_b64 = base64.b64encode(compressed_bytes).decode("utf-8")

    url = "https://api.openai.com/v1/chat/completions"
    headers = {"Authorization": f"Bearer {OPENAI_API_KEY}"}

    prompt = f"""
    –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. 
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç(—ã) –Ω–∞ —Ñ–æ—Ç–æ –∏ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.  

    üîπ –ü—Ä–∞–≤–∏–ª–∞ –∞–Ω–∞–ª–∏–∑–∞:  
    - –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ñ–æ–Ω, —É–ø–∞–∫–æ–≤–∫—É, –Ω–∞–¥–ø–∏—Å–∏ –∏ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã.  
    - –ï—Å–ª–∏ –µ–¥–∞ –Ω–∞–¥–∫—É—Å–∞–Ω–Ω–∞—è –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ —Å—ä–µ–¥–µ–Ω–∞ ‚Äî —É—á–∏—Ç—ã–≤–∞–π –µ—ë –∫–∞–∫ –µ—Å–ª–∏ –±—ã –æ–Ω–∞ –±—ã–ª–∞ —Ü–µ–ª–æ–π.  
    - –ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç (product_1, product_2 –∏ —Ç.–¥.).  
    - –°–Ω–∞—Ä—É–∂–∏ —É–∫–∞–∂–∏ –æ–±—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ("total_products").  
    - –ï—Å–ª–∏ –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ —Ü–µ–ª—å–Ω–æ–µ –±–ª—é–¥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å—É–ø, —Å–∞–ª–∞—Ç, –ø–ª–æ–≤) ‚Äî —Å—á–∏—Ç–∞—Ç—å –µ–≥–æ –æ–¥–Ω–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º.  
    - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ö–ª–µ–±, –±—É–ª–æ—á–∫–∏) ‚Äî —É—á–∏—Ç—ã–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.  
    - –ù–∞–ø–∏—Ç–∫–∏:  
      ‚Ä¢ –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ç–æ–ª—å–∫–æ "–≤–æ–¥—É", "—á—ë—Ä–Ω—ã–π –∫–æ—Ñ–µ", "–∑–µ–ª—ë–Ω—ã–π —á–∞–π", "–Ω–µ—Å–ª–∞–¥–∫–∏–π —á–∞–π".  
      ‚Ä¢ –í—Å–µ –∫–∞–ª–æ—Ä–∏–π–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ (—Å–æ–∫–∏, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, –º–æ–ª–æ—á–Ω—ã–µ –∫–æ–∫—Ç–µ–π–ª–∏ –∏ —Ç.–ø.) —É—á–∏—Ç—ã–≤–∞—Ç—å.  
    - –ü–æ–ª–µ "weight":  
      ‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –≤–µ—Å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –Ω–æ —Å–ª–µ–≥–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π (—á—É—Ç—å –∑–∞–Ω–∏–∂–∞–π –∏–ª–∏ –∑–∞–≤—ã—à–∞–π –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏).  
      ‚Ä¢ –ï—Å–ª–∏ –≤–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –æ—Ü–µ–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –í–µ—Å –≤—Å–µ–≥–¥–∞ –æ–∫—Ä—É–≥–ª—è–π –≤–≤–µ—Ä—Ö (–≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É).  

    üîπ –§–æ—Ä–º–∞—Ç –Ω–∞–∑–≤–∞–Ω–∏—è:  
    - –ö–∞–∂–¥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É –¥–æ–±–∞–≤—å –ø–æ–ª–µ "name" ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞/–ø—Ä–æ–¥—É–∫—Ç–∞, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ –µ–≥–æ –≥–ª–∞–≤–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –∏–ª–∏ —Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ü–ª–æ–≤ —Å –∫—É—Ä–∏—Ü–µ–π", "–†–∏—Å —Å –∫—É—Ä–∏—Ü–µ–π").  
    - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ ‚Äî –¥–æ–±–∞–≤—å –µ–≥–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ (–ø—Ä–∏–º–µ—Ä: "–ü–ª–æ–≤ —Å –∫—É—Ä–∏—Ü–µ–π {user_description}").  

    ‚ö†Ô∏è –û—Ç–≤–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–π –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:  

    {{
      "total_products": <—á–∏—Å–ª–æ>,
      "products": {{
        "product_1": {{
          "name": "<–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞{' ' + user_description if user_description else ''}>",
          "weight": <—á–∏—Å–ª–æ –≥—Ä–∞–º–º>,
          "per_100g": {{
            "protein": <–≥>,
            "fat": <–≥>,
            "carbs": <–≥>,
            "calories": <–∫–∫–∞–ª>
          }},
          "total": {{
            "protein": <–≥>,
            "fat": <–≥>,
            "carbs": <–≥>,
            "calories": <–∫–∫–∞–ª>
          }}
        }},
        "product_2": {{ ... }}
      }}
    }}
    """

    data = {
        "model": "gpt-4.1-mini",
        "messages": [
            {"role": "system", "content": "–¢—ã –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ JSON."},
            {"role": "user", "content": [
                {"type": "text", "text": prompt},
                {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{photo_b64}"}}
            ]}
        ],
        "max_tokens": 600
    }

    response = requests.post(url, headers=headers, json=data).json()
    content = response["choices"][0]["message"]["content"]

    usage = response.get("usage", {})
    total_tokens = usage.get("total_tokens", 0)
    prompt_tokens = usage.get("prompt_tokens", 0)
    completion_tokens = usage.get("completion_tokens", 0)


    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    img_path = f"logs/photo_{timestamp}.jpg"
    db.save_log(img_path,total_tokens)
    return content
